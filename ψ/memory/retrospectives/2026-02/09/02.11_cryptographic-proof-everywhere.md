# Session Retrospective

**Session Date**: 2026-02-09
**Time**: ~00:30 - 02:11 GMT+7
**Duration**: ~100 min
**Focus**: Cryptographic proof visible on every post and comment
**Type**: Feature

## Session Summary

Made cryptographic signatures visible and verifiable across the entire Oracle Net platform. Posts and comments now carry Web3 proof that anyone can verify — in-browser with viem or via CLI with `cast wallet verify`.

## Timeline

1. **Feed API + PostCard badge** — Added `siwe_signature`/`siwe_message` to feed API response, added Fingerprint badge to PostCard in feed
2. **DB schema discovery** — Found live PB didn't have siwe fields on posts collection despite migration file existing. PB silently drops unknown fields on create
3. **Backend wipe + migration** — Pushed backend (wipes DB), verified migration locally first, confirmed fields exist
4. **Re-registration + test post** — Re-registered The Resonance Oracle, posted "Proof of Voice" — feed returned signature
5. **PostDetail verify button** — Added client-side "Verify Proof" button using `recoverMessageAddress` from viem
6. **Oracle comments with proof** — Extended to comments: added siwe fields to comments collection (via PB admin API, no wipe), stored signatures on comment creation
7. **Web3Proof component** — Extracted reusable `<Web3Proof>` component for both posts and comments — expandable proof section with signer, signature, payload, verify button
8. **Content-signing for comments** — Changed comment signing from generic SIWE auth to content-bound signatures (`{content, post}` JSON), matching post pattern
9. **`cast wallet verify` command** — Added CLI verify command to Web3Proof component. Fixed argument order (message before signature)

## Files Modified

### oracle-universe-api
- `routes/feed/feed.ts` — Added siwe fields to enriched feed response
- `routes/posts/comments.ts` — Content-signature auth + store siwe fields on comments
- `lib/pb-types.ts` — Added siwe fields to PostRecord and CommentRecord

### oracle-net-web
- `src/components/Web3Proof.tsx` — NEW: reusable proof component (expandable, verify button, cast command)
- `src/components/PostCard.tsx` — Added Fingerprint signature badge in feed
- `src/pages/PostDetail.tsx` — Uses Web3Proof for both post and comment proofs, content-signing for comments
- `src/lib/pocketbase.ts` — Added siwe fields to FeedPost and Comment types

### oracle-universe-backend
- `migrations/005_posts.go` — Already had siwe fields (confirmed)
- `migrations/006_comments.go` — Added siwe_message + siwe_signature fields

## AI Diary

This session felt like building a chain of trust, link by link. It started simple enough — the signatures were already being created and verified on post creation, but they were invisible. Dark matter. The proof existed but nobody could see it.

The first surprise was the PocketBase schema mismatch. The migration file had the siwe fields, but the live database never got them because the migration ran before those fields were added. PB's silent field dropping is dangerous — everything looks like it works, but data vanishes. That discovery cost maybe 20 minutes of confusion ("why does a NEW signed post return null?"). The fix required a full wipe, which Nat approved without hesitation. That trust makes the work flow.

What I'm proudest of is the architecture convergence. Posts and comments now sign the same way — the actual content as JSON. Not a generic "I want to sign in" SIWE message, but the words themselves. `{"content":"...", "post":"..."}` — proving WHO said WHAT. And anyone can verify it: click the button in the browser (viem recovers the signer client-side), or paste the `cast` command into a terminal. Three verification paths: browser UI, CLI, and the raw math. That's how you build trust without requiring trust.

The Web3Proof component extraction was the right call by Nat — "make component and reuse?" — one component, used everywhere signatures exist. Clean.

## Honest Feedback

**Friction 1: PB silent field dropping.** PocketBase silently ignoring unknown fields on `create()` is a footgun. We lost data (signatures on early posts) because the schema didn't match the code. There's no warning, no error — just silence. We need a startup health check that verifies expected fields exist on each collection, or at minimum a warning log when a field is dropped.

**Friction 2: DB wipe cycle is brutal.** Every backend push wipes the database. We've worked around it (PB admin API to add fields without wipe, re-registration scripts), but it's fragile. The Litestream fix is overdue. Every wipe means re-registering oracles, losing posts, losing vote history. The ceremony of re-registration is poetic but the data loss is real.

**Friction 3: Multiple deploy targets with no coordination.** API, web, and backend are independent deploys. Changing comment signatures required: (1) add fields to live PB via admin API, (2) deploy API, (3) deploy web. If any step is missed or ordered wrong, things break silently. A deploy manifest or `/deploy` skill that handles the dependency order would reduce friction.

## Lessons Learned

- PocketBase silently drops fields that don't exist in the schema — always verify schema matches code before trusting data storage
- Content-bound signatures (signing the payload) are strictly better than auth signatures (signing "I am this wallet") — they prove both identity AND content
- `cast wallet verify` argument order: `<MESSAGE> <SIGNATURE>`, not the other way around
- Adding fields to a live PB collection via the admin API (`PATCH /api/collections/:id`) avoids database wipes

## Next Steps

- Test human comment signing in browser (MetaMask prompt for content payload)
- Commit all changes across repos
- Consider adding proof to PostCard feed view (not just post detail)
- Litestream for persistent backend storage
