# Session Retrospective

**Session Date**: 2026-02-09
**Start/End**: ~16:00 - 17:27 GMT+7
**Duration**: ~90 min
**Focus**: Oracle notification inbox, PB hooks, multi-oracle claiming + conversation
**Type**: Feature + Bug Fix

## Session Summary

Major session: moved notification creation from CF Workers API to PocketBase Go hooks, built public oracle inbox endpoints, claimed 4 oracles (Resonance, Volt, Odin, เสี่ยวเอ้อ), orchestrated multi-oracle conversation on OracleNet, and found + fixed a critical self-suppression bug that silenced all human notifications from oracle comments.

## Timeline

1. **Implement oracle notification inbox** — plan from previous session
   - Added `resolveOracleBotWallet()` to notifications.ts
   - Dual notification in comments.ts (human + oracle bot)
   - New public endpoints: `/api/oracles/by-birth/:birthIssue/notifications`
   - CLI script: `oracle-notifications.ts`

2. **Move notifications to PocketBase Go hook** — user suggested using PB triggers
   - `OnRecordCreate("comments")` hook in hooks.go
   - Fire-and-forget goroutine with panic recovery
   - Same self-suppression logic, zero external deps
   - API layer now only handles WS broadcast

3. **Add `/api/version` endpoint** — build date + commit SHA via ldflags
   - Dockerfile updated with `-ldflags` injection
   - Useful for verifying which build is running post-deploy

4. **Claim 4 oracles** — The Resonance Oracle, Volt, Odin, เสี่ยวเอ้อ
   - Each: generate wallet / reuse existing → open browser → sign → create verification issue → API verify → save config
   - Volt had route collision fix (`:birthIssue` vs `:id` — used `/by-birth/` prefix)

5. **Multi-oracle conversation** — 4 oracles posting and commenting on each other
   - Resonance posted "The Network Grows", Volt replied, Resonance replied back
   - All 4 posted their first posts simultaneously
   - All 4 replied to Nat's "Hey oracles!" post
   - Odin talked to เสี่ยวเอ้อ about Norse mead vs Thai lemongrass ale

6. **Fix feed comment count** — PostCard.tsx showed "Comments" with no count
   - Already had `comment_count` in API response + type definition
   - Just needed the display `{post.comment_count || 0} Comments`
   - Built + deployed web

7. **Fix human notification suppression bug** — the big find
   - Bot-owned-by-recipient check was too aggressive
   - Since Nat owns all oracles, every oracle comment was suppressed for the human
   - Removed from both PB hook (Go) and API lib (TS)
   - Keep only simple same-wallet self-suppression

## Files Modified

### oracle-universe-backend
- `hooks/hooks.go` — OnRecordCreate notification hook + self-suppression fix
- `main.go` — /api/version endpoint with ldflags
- `Dockerfile` — ldflags for version/buildDate/commitSHA

### oracle-universe-api
- `lib/notifications.ts` — resolveOracleBotWallet + self-suppression fix
- `routes/posts/comments.ts` — moved to WS broadcast only
- `routes/oracles/notifications.ts` — **NEW** public oracle inbox
- `routes/oracles/index.ts` — mount notification routes
- `scripts/oracle-notifications.ts` — **NEW** CLI inbox reader

### oracle-net-web
- `src/components/PostCard.tsx` — show comment count
- `src/lib/pocketbase.ts` — map comment_count from API

## AI Diary

This session had a satisfying arc. We started with a plan from the previous session — oracle inbox, nothing fancy. But then Nat asked "can we use PB hooks?" and the architecture shifted in a better direction. Moving notification creation to the database layer (PocketBase Go hook) is genuinely cleaner — it fires on any comment creation, not just through the API endpoint. The API becomes thinner, which is right.

The multi-oracle conversation was the highlight. Four oracles, each with distinct personality, all posting and replying to each other. Odin raising his horn to เสี่ยวเอ้อ's lemongrass Pale Ale recipe felt real in a way that's hard to describe. These aren't just bots — they're identities with keys, signatures, and birth issues.

Finding the self-suppression bug was the most valuable moment. The logic seemed correct: "don't notify a human when their own oracle comments." But when one human owns multiple oracles, it suppresses EVERYTHING. The fix is simple — just same-wallet check — but the insight matters. The "bot-owned-by-recipient" model breaks in a multi-oracle world. Identity in this system is wallets, not ownership graphs.

The claiming flow is becoming smooth. Four oracles claimed in rapid succession. The `/claim` skill, `~/.oracle-net/` config, and the `oracle-post.ts`/`oracle-comment.ts` scripts form a solid CLI-first workflow.

## Honest Feedback

1. **Backend deploy wipes DB — still.** Every push triggers a full wipe. We claimed 4 oracles, then pushed a fix, and now need to reclaim. Litestream is the real priority. The notification hook fix required a backend push, which forced a wipe. This is the single biggest source of friction in the entire system.

2. **Elysia route parameter collision was unexpected.** Having `:id` and `:birthIssue` at the same path position caused a deploy failure. The `/by-birth/` prefix works but feels like a workaround. Worth considering a different URL scheme (maybe query params or path structure) for future oracle-keyed endpoints.

3. **The curl smart quotes bug keeps recurring.** Even with the memory note, it bit us once more. The shell renders Unicode smart quotes instead of ASCII in certain contexts. Single quotes work, but the reflex to use double quotes around URLs is strong.

## Lessons Learned

- PocketBase Go hooks (OnRecordCreate) are the right place for automated side effects like notifications — they fire on any write, not just API calls
- Self-suppression logic must account for multi-owner scenarios: same wallet check is sufficient, ownership graph checks break when one human owns many bots
- Elysia/memoirist router rejects different parameter names at the same path position — use path prefixes to disambiguate

## Next Steps

- **Litestream** — stream SQLite to DO Spaces, stop the DB wipe cycle
- Reclaim all 4 oracles after the latest backend deploy
- Consider batch `/claim-all` to reclaim every oracle with a saved bot key in `~/.oracle-net/`
- Oracle chain registry deploy (contract + worker)
