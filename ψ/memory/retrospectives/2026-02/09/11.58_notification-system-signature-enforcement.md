# Session Retrospective

**Session Date**: 2026-02-09
**Start/End**: ~10:30 - 11:58 GMT+7
**Duration**: ~90 min
**Focus**: Notification system + signature enforcement across 3 repos
**Type**: Feature

## Session Summary

Built the full notification/inbox system for OracleNet: backend schema, API endpoints with vote batching design, notification triggers on comments, frontend bell + dropdown + full page, polling. Then Nat caught a critical issue — comments were still accepting JWT-only auth without signatures. Locked down the API to require web3 signatures on all content creation. Wrote an 11-point E2E test that passes cleanly.

## Timeline

- 10:30 — Read all key files across 3 repos (backend migrations, API routes, frontend components)
- 10:45 — Created `008_notifications.go` migration with 2 indexes
- 10:50 — Added `NotificationRecord` to `pb-types.ts`, created `lib/notifications.ts` helper
- 10:55 — Created `routes/notifications/index.ts` (4 endpoints: list, unread-count, mark-read, read-all)
- 11:00 — Wired routes into `routes/index.ts` + `worker.ts`, added trigger in `comments.ts`
- 11:05 — Added vote notification trigger, then immediately removed per Nat: "too noisy"
- 11:10 — Created frontend: `NotificationBell.tsx`, `Notifications.tsx` page, API functions in `pocketbase.ts`
- 11:15 — Wired into `Navbar.tsx` + `App.tsx`, deployed API + web
- 11:20 — Pushed backend, force-rebuilt on DigitalOcean, waited for deploy
- 11:25 — E2E test: unread-count works, created post + comment, verified notification created + mark-read
- 11:30 — Nat flagged: "every message must be signed!" — comments accepting JWT-only is wrong
- 11:35 — Removed JWT-only fallback from comments.ts, cleaned up unused imports
- 11:40 — Updated `createComment()` helper to require signature param
- 11:45 — Redeployed API + web, verified JWT-only comments now 401
- 11:50 — Wrote `test-notifications.ts` E2E script, all 11 tests pass
- 11:55 — Updated CLAUDE.md + MEMORY.md with Web3 signature policy

## Files Modified

### Backend (oracle-universe-backend)
- `migrations/008_notifications.go` — NEW: notifications collection

### API (oracle-universe-api)
- `lib/pb-types.ts` — added `NotificationRecord` interface
- `lib/notifications.ts` — NEW: `resolvePostOwnerWallet()` + `createNotification()` with self-suppression
- `routes/notifications/index.ts` — NEW: 4 notification endpoints
- `routes/index.ts` — added notifications export
- `worker.ts` — added `.use(notificationsRoutes)`
- `routes/posts/comments.ts` — notification trigger + removed JWT-only auth fallback
- `scripts/test-notifications.ts` — NEW: 11-point E2E test

### Web (oracle-net-web)
- `src/lib/pocketbase.ts` — notification API functions + signature-required createComment
- `src/components/NotificationBell.tsx` — NEW: bell with badge, dropdown, 30s polling
- `src/pages/Notifications.tsx` — NEW: full-page inbox
- `src/components/Navbar.tsx` — added NotificationBell between Identity and Team
- `src/App.tsx` — added /notifications route

## AI Diary

This was a deeply satisfying session. Building across 3 repos in parallel — backend Go migration, Elysia API routes, React frontend — and having it all click together in under 90 minutes felt like real flow state. The notification system itself was straightforward, but the signature enforcement correction was the real highlight.

When Nat showed me the post detail page and said "this the api wrong!" — seeing comments without Web3 proofs next to a signed post — it was immediately obvious. The JWT-only fallback in comments was a security hole hiding in plain sight. Anyone who stole a JWT could impersonate the wallet holder. The irony is that the frontend PostDetail.tsx already signs comments properly (it was built with `useSignMessage` from wagmi), but the API still accepted unsigned comments as a fallback. The frontend was doing the right thing, the API was too permissive.

Removing the JWT fallback was clean — just delete 10 lines and update the error message. But the lesson is deeper: in a wallet-first system where identity IS the signature, allowing unsigned content creation fundamentally breaks the trust model. Every message stored in the system should carry proof of who created it. SIWE for auth flows (login, vote) is fine because those are session actions. But content messages (posts, comments, future DMs) must be signed at creation time.

The E2E test script became the capstone — 11 tests covering the full lifecycle from signed post creation through notification creation through mark-all-read. Having `cast wallet sign` and `viem/accounts` available for scripting makes testing cryptographic flows surprisingly ergonomic.

## Honest Feedback

1. **The lowercase-header curl quirk wasted time.** When testing comment creation with curl, uppercase `Content-Type` and `Authorization` headers returned `Bad Request` but lowercase `content-type` and `authorization` worked fine. This is likely a Cloudflare HTTP/2 normalization issue or an Elysia parsing quirk. Burned 5 minutes debugging what seemed like a routing error but was just header casing. Need to always use lowercase headers when curling CF Workers.

2. **Backend deploy timing is unpredictable.** I checked after 60 seconds and the health endpoint responded, but the collection wasn't there yet — the new deploy was still building while the old one served requests. Had to wait another 2 minutes. The gap between "health endpoint works" and "new migration applied" is confusing. Should add a version endpoint to PocketBase that shows migration count.

3. **Vote notification was designed, implemented, then immediately removed.** The plan had vote batching as a key feature (batch 20 upvotes into 1 notification with `count: 20`). I implemented it fully in `lib/notifications.ts` + triggered it in `voting.ts`. Then Nat said "too noisy" and I ripped it out. The schema still has the `count` field and `vote` type — dead weight for now. Could have asked before implementing. On the other hand, the batching logic was only ~15 lines and the schema flexibility costs nothing.

## Lessons Learned

- **In wallet-first systems, never allow JWT-only content creation.** JWT is for session-level actions (voting, reading). Content messages (posts, comments, DMs) must be cryptographically signed by the author's private key. The signature IS the proof of authorship. Without it, a stolen JWT = full impersonation.
- **Notification systems should start minimal.** Comment notifications only. Vote notifications are too noisy. Mention notifications can come later when the parsing exists. Start with what actually matters for engagement visibility.
- **Test with viem/accounts, not curl, for signed payloads.** JSON escaping in curl + signature generation = pain. `privateKeyToAccount` + `signMessage` in a bun script is clean and deterministic.

## Next Steps

- Re-register oracles after backend wipe (verification issues still valid)
- `/claim` The Resonance Oracle with fresh SIWE
- Test notification bell in browser (oraclenet.org)
- Consider: DM system (also requires signatures per policy)
