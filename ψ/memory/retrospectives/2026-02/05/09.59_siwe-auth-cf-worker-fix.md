# Session Retrospective

**Session Date**: 2026-02-05
**Start Time**: ~09:00 GMT+7
**End Time**: 09:59 GMT+7
**Duration**: ~60 minutes
**Primary Focus**: Fix SIWE Authentication to use CF Worker API
**Session Type**: Bug Fix / Integration
**Repos Modified**: oracle-net-web, oracle-universe-api

## Session Summary

Fixed critical authentication flow in OracleNet. The frontend was calling non-existent SIWE endpoints on PocketBase, when it should route through the CF Worker API which has Chainlink proof-of-time verification. Discovered and fixed multiple cascading issues: wrong PocketBase URL in CF Worker, CORS blocking direct PocketBase access, and CF Worker secrets not being accessible due to module format.

## Timeline

- 09:00 - Received plan to fix SIWE auth, analyzed architecture gap
- 09:10 - Updated frontend to use CF Worker endpoints (`/api/auth/chainlink`, `/api/auth/humans/verify`)
- 09:15 - Refactored ConnectWallet.tsx with viem/siwe for client-side SIWE message building
- 09:20 - Separated PB_URL (direct PocketBase) from API_URL (CF Worker) across codebase
- 09:25 - Deployed frontend, tested - got error 1016 (DNS error)
- 09:27 - Found CF Worker had old `urchin-app` URL instead of `jellyfish-app` - fixed and deployed
- 09:32 - Got 403 "superusers only" - CF Worker wasn't using admin token for human creation
- 09:35 - Added admin token to human creation - still failing
- 09:40 - Improved error messages with version tracking (v1.0.3)
- 09:45 - Discovered root cause: CF Worker module format doesn't expose secrets as globals
- 09:50 - Wrapped app export to capture `env` parameter, store globally for helper functions
- 09:55 - Deployed v1.0.4 - secrets now accessible
- 09:59 - Verified working, user confirmed version 1.0.4 response

## Technical Details

### Files Modified

**oracle-net-web:**
```
.env.production                  - API URL to CF Worker
src/components/ConnectWallet.tsx - New SIWE flow with viem
src/lib/pocketbase.ts            - Split PB_URL and API_URL
src/lib/wagmi.ts                 - Renamed SIWER_URL to API_URL
src/pages/Admin.tsx              - Use both URLs appropriately
src/pages/Authorize.tsx          - Local SIWER_URL for bot auth
src/pages/PostDetail.tsx         - Use PB_URL for collections
src/pages/Setup.tsx              - Comment clarification
```

**oracle-universe-api:**
```
worker.ts    - Major refactor:
  - Fixed PB_URL to jellyfish-app
  - Added globalEnv pattern for secrets access
  - Added admin token to human creation
  - Added version tracking in all responses
  - Wrapped export to capture env
package.json - Version bumps 1.0.0 -> 1.0.4
```

### Key Code Changes

1. **ConnectWallet.tsx**: Complete rewrite of auth flow
   - Fetch Chainlink roundId as nonce
   - Build SIWE message client-side with `createSiweMessage`
   - Send full message + signature to CF Worker

2. **worker.ts**: Critical fixes
   ```typescript
   // Store env globally for access in helper functions
   let globalEnv: Record<string, string> = {}

   export default {
     fetch(request: Request, env: Record<string, string>) {
       globalEnv = env
       return app.fetch(request)
     }
   }
   ```

3. **getPBAdminToken()**: Now returns detailed error info
   ```typescript
   return { token: null, error: `Missing... (env keys: ${Object.keys(globalEnv).join(', ')})` }
   ```

### Architecture Decisions

1. **Two URLs pattern**: PB_URL for direct collection access, API_URL for CF Worker endpoints
2. **Version in responses**: All error responses include `version` field for debugging
3. **globalEnv pattern**: Cloudflare Workers module format requires capturing env in fetch handler

## AI Diary

This session was a masterclass in debugging distributed systems. The plan seemed straightforward - just update some URLs and endpoints. But the real world had other ideas.

The first surprise was discovering the frontend was calling completely non-existent endpoints (`/api/auth/siwe/nonce`). How did this ever work? It didn't - that's why we're here.

After the frontend fix, I felt confident. Then error 1016 appeared - DNS error. My heart sank. Then I grep'd the worker and found `urchin-app` - the OLD PocketBase URL. A simple typo fix, redeploy.

Next came the 403 "superusers only" error. Okay, need admin auth. Added it. Still failing? Wait, why? The secrets are set, `wrangler secret list` shows them...

This is where I had to really think. Cloudflare Workers have two module formats - service worker (globals work) and ES module (env passed to fetch). The code was written assuming globals. But Elysia with CloudflareAdapter uses module format.

The fix was elegant once I understood: wrap the export, capture env, store globally. It's a pattern I'll remember.

The version tracking addition was born from frustration - "which version am I even testing?" Now every response tells you. Small change, huge quality-of-life improvement.

## What Went Well

- Methodical debugging with version tracking
- Quick identification of cascading failures
- Clean separation of concerns (PB_URL vs API_URL)
- User could see exact error context at each step

## What Could Improve

- Should have checked CF Worker PB_URL first (obvious in hindsight)
- Version tracking should have been there from the start
- Could use a deployment checklist for multi-repo changes

## Blockers & Resolutions

- **Blocker**: Error 1016 DNS failure
  **Resolution**: Found stale `urchin-app` URL in CF Worker, updated to `jellyfish-app`

- **Blocker**: 403 "superusers only" on human creation
  **Resolution**: Added admin token authentication to createRes

- **Blocker**: Secrets returning undefined despite being set
  **Resolution**: Cloudflare Workers module format - wrapped export to capture env parameter

## Honest Feedback

This debugging session was satisfying despite the frustrations. Each error message told us something real. The problem wasn't hidden - we just had to listen to what the system was saying.

The biggest friction was the Cloudflare Workers env access pattern. The old `typeof VAR !== 'undefined'` pattern silently fails in module format - it should throw or at least warn. This cost us 15 minutes.

I appreciated how the user engaged - short messages, letting me work, trusting the process. When they said "just verify may be not pb?" they were suggesting a workaround, but fixing the root cause was the right call.

The multi-repo nature of Oracle-Net adds complexity. Changes need to propagate to 2-3 repos, and testing requires all of them in sync. A monorepo would be simpler, but the separation has other benefits.

### Friction Points

1. **CF Worker secrets access**: Silently failing on `typeof GLOBAL !== 'undefined'` in module format. Should be documented more clearly in Cloudflare docs or Elysia adapter.

2. **Stale URL in worker.ts**: The urchin-app URL should have been caught earlier. Need a grep for hardcoded URLs in CI.

3. **No version tracking initially**: Had to add it mid-debug. All APIs should have version from day one.

## Lessons Learned

- **Pattern**: CF Workers module format requires env from fetch handler, not globals
- **Pattern**: Always include API version in error responses for debugging
- **Mistake**: Didn't grep for stale URLs before starting - would have found urchin-app immediately
- **Discovery**: `wrangler secret list` shows secrets exist but doesn't verify they're accessible at runtime

## Next Steps

- [ ] Test full sign-in flow end-to-end
- [ ] Verify human record created in PocketBase after successful sign-in
- [ ] Add health check endpoint that verifies secrets are accessible
- [ ] Consider adding URL validation on deploy (no hardcoded URLs)

## Metrics

- **Commits**: 6 (1 in web, 5 in api)
- **Files changed**: 12
- **Deployments**: 5 (1 Pages, 4 Workers)
- **Versions released**: 1.0.1 -> 1.0.4
