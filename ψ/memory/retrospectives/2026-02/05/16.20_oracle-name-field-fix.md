# Session Retrospective: Oracle Name Display Fix

**Session Date**: 2026-02-05
**Start Time**: 16:00 GMT+7
**End Time**: 16:20 GMT+7
**Duration**: ~20 minutes
**Primary Focus**: Fix Oracle identity verification displaying wrong name
**Session Type**: Bug Fix
**Repos**: oracle-universe-api, oracle-net-web

## Session Summary

Fixed a critical bug where Oracle identity verification displayed the GitHub username ("nazt") instead of the Oracle name ("SHRIMP Oracle"). The root cause was saving to a non-existent PocketBase field (`oracle_name`) which was silently ignored, while `name` field received the GitHub username instead.

## Timeline

- 16:00 - User reported Oracle showing "nazt" instead of "SHRIMP Oracle" on /identity page
- 16:05 - Investigated `routes/auth/identity.ts`, found schema mismatch
- 16:10 - Identified root cause: `name: githubUsername` and `oracle_name: finalOracleName` (non-existent field)
- 16:15 - Applied fix: `name: finalOracleName`, removed `oracle_name` and `claimed` fields
- 16:17 - Tests passed (56/56), deployed oracle-universe-api
- 16:18 - User requested verification form always visible for re-verification
- 16:19 - Updated Identity.tsx to show form regardless of verification status
- 16:20 - Deployed oracle-net-web, committed and pushed both repos

## Technical Details

### Files Modified

```
oracle-universe-api:
  routes/auth/identity.ts (+14, -12)

oracle-net-web:
  src/pages/Identity.tsx (+14, -22)
```

### Key Code Changes

**oracle-universe-api/routes/auth/identity.ts:**
- Create oracle: Changed `name: githubUsername` → `name: finalOracleName`
- Update oracle: Changed `oracle_name: finalOracleName, claimed: true` → `name: finalOracleName, approved: true`
- Response: Removed non-existent `oracle_name` from response object
- Added admin auth headers to search requests

**oracle-net-web/src/pages/Identity.tsx:**
- Changed condition from `{!isFullyVerified && !verifySuccess && (` to `{!verifySuccess && (`
- This allows verified users to see the form and re-verify to update their Oracle name

### Architecture Decisions

- **Use existing schema fields only**: PocketBase silently ignores unknown fields, so we must use `name` (which exists) instead of `oracle_name` (which doesn't)
- **Always show verification form**: Users need ability to re-verify to fix incorrect data, not just verify once

## AI Diary

This session was a textbook example of "silent failure" debugging. When Nat showed me the screenshot with "nazt" appearing instead of "SHRIMP Oracle", my first instinct was to trace the data flow. The plan from plan mode was excellent - it had already identified the root cause precisely.

What struck me was the subtlety of the bug. PocketBase doesn't throw errors for unknown fields - it just silently drops them. The code looked correct at a glance: `oracle_name: finalOracleName` seemed like it was storing the Oracle name. But the schema only had `name`, not `oracle_name`. So `name` got `githubUsername` and `oracle_name` went into the void.

The fix was straightforward once understood - just use the correct field. But then Nat showed me the old UI screenshot and wanted the verification form back. I realized the current UX blocked re-verification for existing users - they couldn't fix their data! Adding `!isFullyVerified` to the condition was hiding the form precisely when users needed it most.

The parallel with today's earlier CF Worker secrets issue is striking - both are "silent failures" where the system accepts input but doesn't do what you expect. No errors, just wrong behavior. This pattern keeps recurring.

## What Went Well

- Plan mode had already done the investigation - fix was surgical
- Tests all passed (56/56) immediately
- Quick turnaround from bug report to deployed fix (~20 min)
- User could verify the fix worked in real-time

## What Could Improve

- Schema validation tests would have caught this earlier
- TypeScript interface had `oracle_name?: string` which didn't match reality
- Could add response validation to verify fields actually saved

## Blockers & Resolutions

- **Blocker**: User couldn't re-verify because form was hidden when `isFullyVerified`
  **Resolution**: Changed condition to always show form, allowing re-verification

## Honest Feedback

This was a clean, focused bug fix session. The investigation had already been done in plan mode, so execution was smooth. The only friction was realizing the UX also needed fixing - the verification form being hidden for verified users was a separate but related issue.

The real lesson here is about PocketBase's silent field dropping. This is a footgun that could bite anyone. There should be a strict mode or at least a warning. The fact that TypeScript interfaces can diverge from actual schema is also problematic - we're writing types that lie.

### Friction Points

1. **PocketBase silent field dropping**: No error when saving to non-existent fields. Should fail loudly or at least warn.
2. **TypeScript interface drift**: `oracle_name?: string` existed in types but not in schema. Need schema-to-types generation.
3. **Hidden re-verification**: UX assumed users only verify once. Real users need to fix mistakes.

## Lessons Learned

- **Pattern**: PocketBase silently ignores unknown fields - always verify schema before writing code
- **Mistake**: Trusted TypeScript interface without checking actual PocketBase schema
- **Discovery**: Silent failures are the hardest to debug - the system "works" but does the wrong thing

## Next Steps

- [ ] Re-verify SHRIMP Oracle at /identity to update the record
- [ ] Consider adding schema validation tests
- [ ] Review other PocketBase saves for similar issues

## Metrics

- **Commits**: 2 (1 per repo)
- **Files changed**: 2
- **Lines added**: 28
- **Lines removed**: 34
- **Tests**: 56 passing

## Retrospective Validation Checklist

- [x] AI Diary section has detailed narrative (not placeholder)
- [x] Honest Feedback section has frank assessment (not placeholder)
- [x] Timeline includes actual times and events
- [x] 3 Friction Points documented
- [x] Lessons Learned has actionable insights
- [x] Next Steps are specific and achievable

---

## Deep Analysis (5-Agent Results)

### Git Analysis (Agent 1)
Today's commits span 4 phases: SIWE auth fix (09:32-10:01), 403 fix & deploy (10:43-10:58), route restructuring (11:44-12:06), and this Oracle name fix (16:19-16:20). Total: 11 commits to oracle-universe-api, 5 to oracle-net-web, 9 to main repo. Code churn: +2,871 insertions, -1,886 deletions across 64 files.

### Architecture Impact (Agent 2)
The fix touches identity verification flow - a critical path for user onboarding. No breaking changes to API contract (response still has `oracle.name`). Frontend change is additive (shows more UI, not less).

### Session Context (Agent 3)
This is the 4th distinct work phase today. Earlier phases established centralized endpoints (`lib/endpoints.ts`) and hybrid route structure - both of which made this fix easier to locate and implement.

### Patterns Extracted (Agent 4)
Key reusable patterns:
- Silent field failure detection: Check response data, not just status
- Admin token caching: Single auth call per request handler
- Multi-stage fallback: `userInput || parsedValue || computedValue || default`

### Oracle Connections (Agent 5)
Related learnings found:
- `2026-02-05_cloudflare-workers-env-module-format.md` - Same "silent failure" pattern
- `2026-01-27_duckdb-date-type-preservation.md` - Type mismatches cause silent comparison failures
- Pattern: "Errors that don't error are the hardest to debug"
